<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Consulta de Refei√ß√µes</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    /* üé® BOT√ÉO ENERGISA */
.btn-energisa {
    background-color: #0057b8;
    color: #fff;
    border: none;
}

.btn-energisa:hover {
    background-color: #00449a;
    color: #fff;
}

/* üîê ADMIN */
.btn-dark {
    background-color: #212529;
    color: #fff;
}

/* üö™ LOGOUT */
.logout-btn {
    background-color: #dc3545;
    color: #fff;
    border: none;
}

.logout-btn:hover {
    background-color: #bb2d3b;
    color: #fff;
}

/* üì± MOBILE ‚Äì BOT√ïES MAIORES */
@media (max-width: 576px) {
    .btn-energisa,
    .btn-dark,
    .logout-btn {
        padding: 12px;
        font-size: 14px;
        border-radius: 10px;
    }
}
/* üîù TOPO RESPONSIVO */
.top-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.top-actions a,
.top-actions button {
    border-radius: 8px;
    font-weight: 600;
}

@media (max-width: 576px) {
    .top-actions {
        flex-direction: column;
        align-items: stretch;
    }

    .top-actions .left-actions {
        display: flex;
        gap: 8px;
        width: 100%;
    }

    .top-actions .left-actions a {
        flex: 1;
        font-size: 14px;
        padding: 12px;
        text-align: center;
    }

    .logout-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
    }
}

:root {
  --blue: #1a73e8;
  --purple: #9334e6;
  --green: #188038;
  --bg: #f1f3f4;
}

body {
  background: var(--bg);
  padding: 12px;
}

/* HEADER */
.header-title {
  background: var(--blue);
  color: white;
  text-align: center;
  padding: 14px;
  border-radius: 14px;
  font-weight: bold;
  margin-bottom: 16px;
  font-size: 1.3rem;
}

/* CALEND√ÅRIO */
.calendario-titulo {
  text-align: center;
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 10px;
}

.calendario {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
}

.dia {
  background: white;
  border-radius: 10px;
  min-height: 90px;
  padding: 6px;
  position: relative;
  font-size: 12px;
}

.dia-num {
  position: absolute;
  top: 6px;
  right: 8px;
  font-size: 12px;
  font-weight: bold;
  color: #555;
}

.evento {
  margin-top: 20px;
  padding: 4px 6px;
  border-radius: 6px;
  font-size: 11px;
  color: white;
  margin-bottom: 4px;
  cursor: pointer;
}

.almoco { background: var(--blue); }
.janta { background: var(--purple); }
.ambos { background: var(--green); }

@media (max-width: 576px) {
  .dia { min-height: 75px; }
  .evento { font-size: 10px; }
}
</style>
</head>

<body>

<div class="container">

  <!-- TOPO COM VOLTAR + ADMIN + LOGOUT -->
    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="d-flex gap-2">
            <a href="https://coec-epb.github.io/prestacao_de_contas/" 
               class="btn btn-energisa">
                ‚¨ÖÔ∏è Voltar
            </a>

            <a href="https://coec-epb.github.io/administrador/" 
               class="btn btn-dark">
                üîê Administra√ß√£o
            </a>
        </div>

        <button type="button" class="btn logout-btn" onclick="logout()">üö™ Sair</button>
    </div>

  <div class="header-title">üìÖ Consulta de Refei√ß√µes</div>

  <!-- FILTROS -->
  <div class="card p-3 mb-3">
    <div class="row g-2">
      <div class="col-md-4">
        <label>Matr√≠cula</label>
        <input id="matricula" class="form-control" readonly>
      </div>
      <div class="col-6 col-md-3">
        <label>M√™s</label>
        <select id="mes" class="form-select">
          <option value="">M√™s</option>
          <option value="01">Janeiro</option>
          <option value="02">Fevereiro</option>
          <option value="03">Mar√ßo</option>
          <option value="04">Abril</option>
          <option value="05">Maio</option>
          <option value="06">Junho</option>
          <option value="07">Julho</option>
          <option value="08">Agosto</option>
          <option value="09">Setembro</option>
          <option value="10">Outubro</option>
          <option value="11">Novembro</option>
          <option value="12">Dezembro</option>
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label>Ano</label>
        <select id="ano" class="form-select"></select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="buscar()">Buscar</button>
      </div>
    </div>
  </div>

  <!-- CALEND√ÅRIO -->
  <div class="card p-3">
    <div id="tituloMes" class="calendario-titulo"></div>
    <div id="calendario" class="calendario"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalDia">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes do Dia</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalConteudo"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    /* üîπ LOGOUT (GLOBAL) */
function logout() {
  localStorage.clear();
  sessionStorage.clear();
  window.location.href = "https://coec-epb.github.io/login/";
}
/* üîπ TODAS AS FUN√á√ïES ORIGINAIS ‚Äî N√ÉO REMOVIDAS */
const matricula = localStorage.getItem("matricula");
document.getElementById("matricula").value = matricula;

const mesesNome = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

const anoAtual = new Date().getFullYear();
const anoSelect = document.getElementById("ano");
for (let a = anoAtual; a >= anoAtual - 5; a--) {
  anoSelect.innerHTML += `<option value="${a}">${a}</option>`;
}

let dadosMes = [];

async function buscar() {
  const mes = document.getElementById("mes").value;
  const ano = document.getElementById("ano").value;

  document.getElementById("tituloMes").innerText = `${mesesNome[mes - 1]} / ${ano}`;

  const resp = await fetch(`https://long-hall-0aaa.pedro-fillype.workers.dev/buscar?matricula=${matricula}&mes=${mes}&ano=${ano}`);
  dadosMes = await resp.json();
  montarCalendario();
}

function montarCalendario() {
  const cal = document.getElementById("calendario");
  cal.innerHTML = "";

  const mes = document.getElementById("mes").value;
  const ano = document.getElementById("ano").value;

  const primeiroDia = new Date(ano, mes - 1, 1).getDay();
  const ultimoDia = new Date(ano, mes, 0).getDate();

  const mapa = {};
  dadosMes.forEach(r => {
    const d = Number(r.datauso.split("-")[2]);
    if (!mapa[d]) mapa[d] = [];
    mapa[d].push(r);
  });

  for (let i = 0; i < primeiroDia; i++) cal.innerHTML += `<div></div>`;

  for (let d = 1; d <= ultimoDia; d++) {
    let eventos = "";
    if (mapa[d]) {
      const tipos = mapa[d].map(r => r.tiporefeicao);
      const classe = tipos.includes("ALMOCO") && tipos.includes("JANTA") ? "ambos" : tipos.includes("ALMOCO") ? "almoco" : "janta";

      eventos = `<div class="evento ${classe}" onclick="abrirDia(${d})">${classe === "ambos" ? "üçΩÔ∏è Almo√ßo + üåô Refei√ß√£o" : classe === "almoco" ? "üçΩÔ∏è Almo√ßo" : "üåô Refei√ß√£o"}</div>`;
    }

    cal.innerHTML += `<div class="dia"><div class="dia-num">${d}</div>${eventos}</div>`;
  }
}

function abrirDia(dia) {
  const lista = dadosMes.filter(item =>
    Number(item.datauso.split("-")[2]) === dia
  );

  let html = "";

  lista.forEach(item => {
    html += `
      <div class="card mb-3 shadow-sm">
        <div class="card-body p-3">

          <h6 class="fw-bold text-primary mb-2">
            üìÖ ${item.datauso} ‚Äî ${item.tiporefeicao}
          </h6>

          <div class="row g-2 small">
            <div class="col-6"><b>ID:</b> ${item.id}</div>
            <div class="col-6"><b>Matr√≠cula:</b> ${item.matricula}</div>

            <div class="col-12"><b>Nome:</b> ${item.nome}</div>
            <div class="col-12"><b>Email:</b> ${item.email}</div>

            <div class="col-6"><b>Regional:</b> ${item.regional}</div>
            <div class="col-6"><b>Polo:</b> ${item.polo}</div>

            <div class="col-6"><b>Hor√°rio:</b> ${item.horario}</div>
            <div class="col-6"><b>Localidade:</b> ${item.localidade}</div>

            <div class="col-12"><b>GPS:</b> ${item.gps}</div>

            <div class="col-4"><b>Sequ√™ncia:</b> ${item.sequencia || "-"}</div>
            <div class="col-4"><b>OS/RR/SS:</b> ${item.osrrss || "-"}</div>
            <div class="col-4"><b>N¬∫ ADD:</b> ${item.numeroadd || "-"}</div>
          </div>

        </div>
      </div>
    `;
  });

  document.getElementById("modalConteudo").innerHTML = html || "<p class='text-center'>Nenhum registro.</p>";
  new bootstrap.Modal(document.getElementById("modalDia")).show();
}
</script>

</body>
</html>
